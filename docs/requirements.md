# Agent Orchestrator Starter 要求定義書

| 項目 | 内容 |
|------|------|
| 文書ID | AOS-REQ-001 |
| バージョン | 1.0.0 |
| 作成日 | 2026-02-27 |
| ステータス | ドラフト |

---

## 1. プロジェクト背景

### 1.1 課題

AI コード生成ツールの普及に伴い、セキュリティリスクが顕在化している。

- Veracode 調査により、AI 生成コードの **45% に OWASP Top 10 の脆弱性** が含まれることが判明
- 初心者がAIエージェントを利用する際、意図せず破壊的操作や秘密情報の漏洩を引き起こすリスクが高い
- エージェント間の協調動作において、権限制御やファイル所有権の管理が欠如すると予期しない副作用が発生する

### 1.2 解決方針

安全なガードレールを組み込んだエージェントオーケストレーションフレームワークのスターターキットを提供し、初心者でも安全にAIエージェントチームを構築・運用できる環境を実現する。

### 1.3 スコープ

| 項目 | 内容 |
|------|------|
| プロダクト名 | Agent Orchestrator Starter |
| 本体リポジトリ | Luna-company/agent-orchestrator |
| 対象ユーザー | Claude Code 初心者、AIエージェント協調開発の入門者 |
| 技術基盤 | Claude Code Agent Teams API |
| エージェント数 | 68種（専門エージェント） |

---

## 2. ビジネス要求

| ID | 要求 | 優先度 |
|----|------|--------|
| BR-001 | 初心者でも安全にAIエージェントチームを運用できること | 必須 |
| BR-002 | セキュリティリスクのある操作を自動検出し、適切な確認フローを強制すること | 必須 |
| BR-003 | 68種類の専門エージェントを単一のプロトコルで統一的に制御できること | 必須 |
| BR-004 | 学習ループにより同じミスを繰り返さない仕組みを提供すること | 重要 |

---

## 3. 機能要求

### FR-001: 4層安全確認プロトコル（DCP）

段階的な安全確認により、操作リスクに応じた適切な制御を行う。

| Tier | レベル | 動作 |
|------|--------|------|
| Tier 1 | 絶対禁止 | 自動ブロック + 代替案提示 |
| Tier 2 | セキュリティリスク | エンジニア確認推奨 |
| Tier 3 | 破壊的操作 | リスク説明の表示 |
| Tier 4 | 通常操作 | 即時実行 |

### FR-002: ガードレール（L1-L4）

段階的な安全制御により、障害の深刻度に応じた対応を自動実行する。

| Level | トリガー | アクション |
|-------|----------|-----------|
| L1 | lint 警告 | ログのみ、続行 |
| L2 | テスト失敗 < 20% | 自動修正試行（最大3回） |
| L3 | テスト失敗 > 50% | ロールバック + 再分解 |
| L4 | 重大セキュリティ | 即時停止 |

### FR-003: 3層パーミッション設定

`settings.json` による権限制御を提供する。

| 権限 | 説明 |
|------|------|
| allow | 確認なしで実行を許可 |
| ask | 実行前にユーザーへ確認 |
| deny | 実行を拒否 |

### FR-004: Hub-spoke アーキテクチャ

全エージェント間通信をオーケストレーター（Nexus/Rally）経由に限定する。

- エージェント間の直接通信を禁止
- 通信の可視化と監査を可能にする
- 障害の波及を防止する

### FR-005: Chain Templates

タスク種別に応じたエージェントチェーンのテンプレートを提供する。

| タスク | チェーン |
|--------|---------|
| バグ修正（簡単） | Scout → Builder → Radar |
| バグ修正（複雑） | Scout → Sherpa → Builder → Radar → Sentinel |
| 機能開発（小） | Builder → Radar |
| 機能開発（中） | Sherpa → Forge → Builder → Radar |
| 機能開発（大） | Sherpa → Rally(Builder + Artisan + Radar) |
| リファクタリング | Zen → Radar |
| セキュリティ監査 | Sentinel → Probe → Builder → Radar |
| PR準備 | Guardian → Judge |

### FR-006: Learning Loop

`lessons.md` による失敗パターンの蓄積と再発防止を行う。

- 失敗パターンを構造化して記録
- 次回以降の同種タスクで自動参照
- 同じミスの繰り返しを防止

### FR-007: Quality Gate

実装完了から報告までの間に品質検証を強制する。

1. 全テストを **2回実行**（安定性確認）
2. **Auditor エージェント** による外部監査（設計整合性・セキュリティ・エッジケース）
3. 両方パスしない限り「完了」と報告しない

### FR-008: Context Recovery Protocol

セッション復帰時のコンテキスト回復手順を標準化する。

1. メモリファイル読み込み
2. プロジェクトの CLAUDE.md 確認
3. `git log --oneline -10` + `git status` で作業状態を把握
4. 圧縮サマリーがあれば読み込み
5. 上記完了まで実装作業に入らない

### FR-009: Read-only Repository Policy

保護対象リポジトリへの4層防御を提供する。

| Layer | 仕組み |
|-------|--------|
| L1 | `remote.pushurl = READONLY_NO_PUSH` |
| L2 | グローバル pre-push hook |
| L3 | Claude Code deny ルール |
| L4 | CLAUDE.md ポリシー |

### FR-010: Secret Handling Policy

チャット経由での秘密情報の取り扱いを禁止する。

- パスワード・APIキー等の値をチャット欄で受け取らない・求めない
- キーの「名前」は可、キーの「値」は不可
- 安全な代替手段: `.env` ファイル、`.env.example` テンプレート、環境変数読み込み

### FR-011: Security by Default

OWASP 対策を実装エージェントに強制する。

- AI 生成コードに対するセキュリティチェックをデフォルトで有効化
- 脆弱性パターンの自動検出と修正提案
- セキュリティ関連の設定をデフォルトで安全側に設定

### FR-012: Plan Mode Enforcement

複雑タスクに対して計画フェーズを強制する。

- タスクの複雑度に応じた計画モードの自動適用
- 計画のレビューと承認フロー
- 計画からの逸脱検知

### FR-013: Parallel Execution

Rally によるブランチ並列実行と File Ownership 制御を提供する。

| パラメータ | 制限 |
|-----------|------|
| 最大ブランチ数 | 4 |
| ブランチあたり最大ステップ | 5 |
| File Ownership | 必須宣言 |
| L4 発動時 | 全ブランチ即時停止 |

### FR-014: Critical Thinking Rule

エージェントの指示鵜呑みを防止する。

- 矛盾や前提の誤りがあれば指摘する
- 代替案には根拠を付ける
- 前提が崩れたら早期報告する
- 過剰批判で手が止まることは禁止（実行速度とのバランス）

### FR-015: Test Policy

テストの SKIP を未完了として扱う。

- SKIP = FAIL（「通った」ではなく「未完了」）
- SKIP があるまま「全テスト通過」と報告しない
- SKIP の理由を把握し、解消可能なら解消する

---

## 4. 非機能要求

| ID | 要求 | カテゴリ |
|----|------|---------|
| NFR-001 | 全出力は日本語で記述すること | ローカライゼーション |
| NFR-002 | Conventional Commits に準拠すること | 開発規約 |
| NFR-003 | エージェント名をコミット・PRに含めないこと | 開発規約 |
| NFR-004 | MEMORY.md は60行以内に制限すること | 運用制約 |
| NFR-005 | Activity Log は20件を保持すること | 運用制約 |
| NFR-006 | 60秒以上沈黙しないこと（Progress Reporting） | 運用品質 |

---

## 5. 制約条件

| ID | 制約 | 影響範囲 |
|----|------|---------|
| CON-001 | Claude Code Agent Teams API に依存 | 実行環境 |
| CON-002 | `.claude/agents/` ディレクトリへの配置が必要 | ファイル構成 |
| CON-003 | `settings.json` による権限制御は Claude Code の仕様に依存 | パーミッション |

---

## 6. 前提条件

| ID | 前提 |
|----|------|
| PRE-001 | Claude Code がインストール済みであること |
| PRE-002 | Git が利用可能であること |
| PRE-003 | GitHub アカウントを保有していること |

---

## 7. 用語定義

| 用語 | 定義 |
|------|------|
| DCP | Danger Confirmation Protocol。4層安全確認プロトコル |
| Hub-spoke | 全通信を中央ノード（オーケストレーター）経由に限定するアーキテクチャ |
| Chain Template | タスク種別に応じたエージェントの実行順序テンプレート |
| Quality Gate | 実装完了から報告までの間に強制される品質検証プロセス |
| Learning Loop | 失敗パターンを蓄積し再発防止する仕組み |
| File Ownership | 並列実行時に各ファイルの編集権限を1エージェントに限定する制御 |
| OWASP Top 10 | Webアプリケーションの重大セキュリティリスク上位10項目 |

---

## 8. トレーサビリティマトリクス

| ビジネス要求 | 関連する機能要求 |
|-------------|----------------|
| BR-001 | FR-001, FR-002, FR-003, FR-008, FR-012 |
| BR-002 | FR-001, FR-002, FR-009, FR-010, FR-011 |
| BR-003 | FR-004, FR-005, FR-013 |
| BR-004 | FR-006, FR-007, FR-014, FR-015 |
